@page "/cotacoes/{QuoteId:guid}/resumo"
@using BlazorAutoCotacao.Dtos.Response
@using BlazorAutoCotacao.Services
@using Microsoft.JSInterop
@using Microsoft.Extensions.Configuration
@inject QuotesService QuotesService
@inject ISnackbar Snackbar
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject IConfiguration Configuration

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (_summary != null)
{
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                    <div style="display:flex; align-items:center;">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Default" Size="Size.Medium"
                            OnClick="GoBackToDetails" Title="Voltar" />

                        <MudText Typo="Typo.h5" Class="ml-2">Resumo da Cotação</MudText>
                    </div>
                    <MudButton Variant="Variant.Filled" Color="Color.Error" StartIcon="@Icons.Material.Filled.PictureAsPdf"
                        OnClick="DownloadSummaryPdf" Size="Size.Small">
                        PDF - Resumo Completo
                    </MudButton>
                </MudStack>

                <MudDivider Class="mb-3" />

                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Modelo</MudText>
                        <MudText Typo="Typo.body2">@_summary.VehicleModel.ToUpper()</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Placa</MudText>
                        <MudText Typo="Typo.body2">@_summary.VehicleLicencePlate.ToUpper()</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Chassi</MudText>
                        <MudText Typo="Typo.body2">@_summary.VehicleVin.ToUpper()</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Ano/Modelo</MudText>
                        <MudText Typo="Typo.body2">@_summary.VehicleYearModel</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        @foreach (var supplier in _summary.Suppliers)
        {
            <MudItem xs="12">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                        <MudText Typo="Typo.h6">@TextHelpers.Capitalize(supplier.SupplierFantasyName)</MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.PictureAsPdf" Color="Color.Error" Size="Size.Medium"
                            OnClick="@(() => DownloadSupplierPdf(supplier.SupplierId))" Title="Download PDF deste fornecedor" />
                    </MudStack>

                    <MudTable T="QuoteItemSummaryDto" Items="supplier.Items" Dense="true" Hover="true" Bordered="true"
                        Striped="false" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Sku</MudTh>
                            <MudTh>Item</MudTh>
                            <MudTh Class="d-none d-sm-table-cell">Qtd</MudTh>
                            <MudTh Class="d-none d-md-table-cell">Marca</MudTh>
                            <MudTh>Preço Unit.</MudTh>
                            <MudTh>Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Sku">@context.Sku</MudTd>
                            <MudTd DataLabel="Item">
                                <MudText Typo="Typo.body2">@TextHelpers.Capitalize(context.ItemName)</MudText>
                                <MudText Typo="Typo.caption" Class="d-sm-none">Qtd: @context.Quantity •
                                    @TextHelpers.Capitalize(context.Brand)</MudText>
                            </MudTd>
                            <MudTd DataLabel="Qtd" Class="d-none d-sm-table-cell">@context.Quantity</MudTd>
                            <MudTd DataLabel="Marca" Class="d-none d-md-table-cell">@TextHelpers.Capitalize(context.Brand)
                            </MudTd>
                            <MudTd DataLabel="Preço Unit.">
                                <MudText Typo="Typo.body2">@TextHelpers.ToCurrency(context.UnitPrice)</MudText>
                            </MudTd>
                            <MudTd DataLabel="Total">
                                <MudText Typo="Typo.body2" Color="Color.Success">
                                    <strong>@TextHelpers.ToCurrency(context.TotalPrice)</strong></MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>

                    <MudDivider Class="my-3" />

                    <MudStack Row="true" Justify="Justify.FlexEnd">
                        <MudText Typo="Typo.h6" Color="Color.Primary">
                            Total @TextHelpers.Capitalize(supplier.SupplierFantasyName): @TextHelpers.ToCurrency(supplier.TotalPrice)
                        </MudText>
                    </MudStack>
                </MudPaper>
            </MudItem>
        }

        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="3">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h5" Color="Color.Success">Total Geral</MudText>
                        <MudText Typo="Typo.h4" Color="Color.Success"><strong>@TextHelpers.ToCurrency(_summary.GrandTotal)</strong>
                    </MudText>
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>
}
else
{
    <MudAlert Severity="Severity.Warning">
        Nenhum item selecionado para esta cotação.
    </MudAlert>
}

@code {
    [Parameter] public Guid QuoteId { get; set; }

    private QuoteSummaryResponse? _summary;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadSummary();
    }

    private async Task LoadSummary()
    {
        try
        {
            _loading = true;
            _summary = await QuotesService.GetQuoteSummaryAsync(QuoteId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar resumo: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task DownloadSummaryPdf()
    {
        try
        {
            var apiBaseUrl = Configuration["ApiBaseUrl"];
            var url = $"{apiBaseUrl}/api/quotes/{QuoteId}/summary/pdf";
            await JS.InvokeVoidAsync("open", url, "_blank");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao baixar PDF: {ex.Message}", Severity.Error);
        }
    }

    private async Task DownloadSupplierPdf(Guid supplierId)
    {
        try
        {
            var apiBaseUrl = Configuration["ApiBaseUrl"];
            var url = $"{apiBaseUrl}/api/quotes/{QuoteId}/supplier/{supplierId}/pdf";
            await JS.InvokeVoidAsync("open", url, "_blank");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao baixar PDF: {ex.Message}", Severity.Error);
        }
    }

    private void GoBackToDetails()
    {
        Navigation.NavigateTo($"cotacoes/{QuoteId}");
    }
}