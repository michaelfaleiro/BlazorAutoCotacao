@page "/cotacoes/{QuoteId:guid}"
@using BlazorAutoCotacao.Dtos.Request
@using BlazorAutoCotacao.Dtos.Response
@using BlazorAutoCotacao.Services
@inject QuotesService QuotesService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (_quote != null)
{
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2">
                <!-- Responsive header: wraps on mobile -->
                <MudStack Row="true" Wrap="Wrap.Wrap" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center"
                    Class="mb-3">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Default" Size="Size.Medium"
                            OnClick="GoBack" aria-label="Voltar" />
                        <div style="margin-left:0;">
                            <MudText Typo="Typo.h5">Cotação #@_quote.Id.ToString().Substring(0, 8)</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Criada em @_quote.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                            @if (_quote.UpdatedAt != null)
                            {
                                <span> • Última atualização @_quote.UpdatedAt.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                            }
                        </MudText>
                        </div>
                    </div>
                    <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap" AlignItems="AlignItems.Center">
                        <!-- Resumo button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Summarize"
                            OnClick="NavigateToSummary">
                            Resumo
                        </MudButton>

                        <!-- Editar button -->
                        <MudButton Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Edit"
                            OnClick="OpenEditQuoteDialog">
                            Editar
                        </MudButton>

                        <!-- Status badge - clickable to change status -->
                        <MudChip T="string" Color="@GetStatusColor(_quote.Status)" Size="Size.Medium"
                            OnClick="OpenUpdateStatusDialog" Icon="@Icons.Material.Filled.Edit" Style="cursor:pointer;">
                            Status: @_quote.Status
                        </MudChip>
                    </MudStack>
                </MudStack>

                <MudDivider Class="mb-3" />

                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption" >Modelo</MudText>
                        <MudText Typo="Typo.body2">@_quote.VehicleModel.ToUpper()</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption" >Placa</MudText>
                        <MudText Typo="Typo.body2">@_quote.VehicleLicencePlate.ToUpper()</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption" >Chassi</MudText>
                        <MudText Typo="Typo.body2">@_quote.VehicleVin</MudText>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudText Typo="Typo.caption" >Ano/Modelo</MudText>
                        <MudText Typo="Typo.body2">@_quote.VehicleYearModel</MudText>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <MudItem xs="12">
            <MudPaper Class="pa-4" Elevation="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-3" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6">Itens da Cotação</MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add"
                        OnClick="OpenAddItemDialog" Size="Size.Small">
                        Adicionar Item
                    </MudButton>
                </MudStack>

                <MudTable T="QuoteItemResponse" Items="_quote.QuoteItems" Dense="true" Hover="true" Bordered="false"
                    Striped="true" Breakpoint="Breakpoint.Sm" FixedHeader="true">
                
                    <HeaderContent>
                        <MudTh Class="d-none d-sm-table-cell"></MudTh>
                        <MudTh>Descrição</MudTh>
                        <MudTh Class="d-none d-sm-table-cell">SKU</MudTh>
                        <MudTh Class="d-none d-sm-table-cell">Observação</MudTh>
                        <MudTh>Quantidade</MudTh>
                        <MudTh Class="d-none d-sm-table-cell">Adicionado</MudTh>
                        <MudTh Style="text-align: right;">Ações</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <!-- Desktop: expand button in first column -->
                        <MudTd DataLabel="" Class="d-none d-sm-table-cell">
                            <MudTooltip
                                Text="@(_expandedItems.Contains(context.Id) ? "Clique para recolher" : "Clique para expandir preços")">
                                <MudIconButton
                                    Icon="@(_expandedItems.Contains(context.Id) ? Icons.Material.Filled.KeyboardArrowUp : Icons.Material.Filled.KeyboardArrowDown)"
                                    Size="Size.Small" OnClick="@(() => ToggleExpand(context.Id))"
                                    aria-label="@(_expandedItems.Contains(context.Id) ? "Recolher" : "Expandir")" />
                            </MudTooltip>
                        </MudTd>
                        <MudTd DataLabel="Item">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.body2">@TextHelpers.Capitalize(context.Name)</MudText>
                                @if (context.SupplierPrices.Any())
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Info">@context.SupplierPrices.Count preços
                                    </MudText>
                                }
                                <MudText Typo="Typo.caption" Class="d-sm-none">SKU: @context.Sku.ToUpper()</MudText>
                                <MudText Typo="Typo.caption" Class="d-sm-none">@TextHelpers.CapitalizeInitials(context.Observation)</MudText>
                            </MudStack>
                        </MudTd>

                        <MudTd DataLabel="SKU" Class="d-none d-sm-table-cell">
                            <MudText Typo="Typo.body2">@context.Sku.ToUpper()</MudText>
                        </MudTd>

                        <MudTd DataLabel="Observação" Class="d-none d-sm-table-cell">
                            <MudText Typo="Typo.body2">@TextHelpers.CapitalizeInitials(context.Observation)</MudText>
                        </MudTd>
                        <MudTd DataLabel="Quantidade">
                            <MudText Typo="Typo.body2"><strong>@context.Quantity</strong></MudText>
                        </MudTd>
                        <MudTd DataLabel="Criado em" Class="d-none d-sm-table-cell">
                            @context.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
                        </MudTd>
                        <MudTd DataLabel="Ações" Style="text-align: right;">
                            <MudTooltip Text="Adicionar Preço de Fornecedor">
                                <MudButton Variant="Variant.Filled" Color="Color.Success" Size="Size.Small"
                                    StartIcon="@Icons.Material.Filled.AttachMoney"
                                    OnClick="@(() => OpenAddPriceDialog(context.Id))" Class="d-none d-sm-inline-flex">
                                    Preço
                                </MudButton>
                            </MudTooltip>
                            <MudTooltip Text="Adicionar Preço">
                                <MudIconButton Icon="@Icons.Material.Filled.AttachMoney" Size="Size.Small"
                                    Color="Color.Success" OnClick="@(() => OpenAddPriceDialog(context.Id))"
                                    Class="d-inline-flex d-sm-none" />
                            </MudTooltip>

                            <MudTooltip Text="Editar Item">
                                <MudButton Variant="Variant.Filled" Color="Color.Warning" Size="Size.Small"
                                    StartIcon="@Icons.Material.Filled.Edit"
                                    OnClick="@(() => OpenEditItemDialog(context.Id))" Class="d-none d-sm-inline-flex">
                                    Editar
                                </MudButton>
                            </MudTooltip>
                            <MudTooltip Text="Editar">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Warning"
                                    OnClick="@(() => OpenEditItemDialog(context.Id))" Class="d-inline-flex d-sm-none" />
                            </MudTooltip>

                            <!-- Mobile: expand button in actions -->
                            <MudTooltip
                                Text="@(_expandedItems.Contains(context.Id) ? "Recolher preços" : "Expandir preços")">
                                <MudIconButton
                                    Icon="@(_expandedItems.Contains(context.Id) ? Icons.Material.Filled.KeyboardArrowUp : Icons.Material.Filled.KeyboardArrowDown)"
                                    Size="Size.Small" Color="Color.Info" OnClick="@(() => ToggleExpand(context.Id))"
                                    Class="d-inline-flex d-sm-none" />
                            </MudTooltip>
                        </MudTd>
                    </RowTemplate>
                    <ChildRowContent>
                        @if (_expandedItems.Contains(context.Id))
                        {
                            var quoteItemId = context.Id;
                            <MudTr>
                                <td colspan="5" style="padding: 0;">
                                    @if (context.SupplierPrices.Any())
                                    {
                                        <MudPaper Elevation="0" Class="pa-3"
                                            Style="background-color: var(--mud-palette-background-grey);">
                                            <MudText Typo="Typo.subtitle2" Class="mb-2">Preços dos Fornecedores</MudText>
                                            @{ var minPrice = context.SupplierPrices.Any() ? context.SupplierPrices.Min(p => p.Price) : 0m; }
                                            <MudTable T="SupplierPriceResponse" Items="context.SupplierPrices" Dense="true"
                                                Hover="true" Bordered="true" Striped="false" Breakpoint="Breakpoint.Xs">
                                                <HeaderContent>
                                                    <MudTh>Fornecedor</MudTh>
                                                    <MudTh Class="d-none d-sm-table-cell">Marca</MudTh>
                                                    <MudTh Class="d-none d-sm-table-cell">SKU</MudTh>
                                                    <MudTh Class="d-none d-sm-table-cell">Observação</MudTh>
                                                    <MudTh>Quantidade</MudTh>
                                                    <MudTh>Preço</MudTh>
                                                    <MudTh Style="text-align: right;">Ações</MudTh>
                                                </HeaderContent>
                                                <RowTemplate Context="price">
                                                    <MudTd DataLabel="Fornecedor">
                                                        <MudText Typo="Typo.body2">@TextHelpers.Capitalize(price.Supplier.FantasyName)</MudText>
                                                        <MudText Typo="Typo.caption" Class="d-sm-none">@TextHelpers.Capitalize(price.Brand)</MudText>
                                                        <MudText Typo="Typo.caption" Class="d-sm-none">SKU: @price.Sku.ToUpper()</MudText>
                                                        <MudText Typo="Typo.caption" Class="d-sm-none">@TextHelpers.CapitalizeInitials(price.Observation)</MudText>
                                                    </MudTd>
                                                    <MudTd DataLabel="Marca" Class="d-none d-sm-table-cell">@TextHelpers.Capitalize(price.Brand)</MudTd>
                                                    <MudTd DataLabel="SKU" Class="d-none d-sm-table-cell">
                                                        <MudText Typo="Typo.body2">@price.Sku.ToUpper()</MudText>
                                                    </MudTd>
                                                    <MudTd DataLabel="Observação" Class="d-none d-sm-table-cell">
                                                        <MudText Typo="Typo.body2">@TextHelpers.CapitalizeInitials(price.Observation)</MudText>
                                                    </MudTd>
                                                    <MudTd DataLabel="Quantidade">
                                                        <MudText Typo="Typo.body2"><strong>@price.Quantity</strong></MudText>
                                                    </MudTd>
                                                    <MudTd DataLabel="Preço">
                                                        <MudText Typo="Typo.body2" Color="@(price.Price == minPrice ? Color.Success : Color.Default)">
                                                               @TextHelpers.ToCurrency(price.Price)</MudText>
                                                    </MudTd>
                                                    <MudTd DataLabel="Ações" Style="text-align: right;">
                                                        @if (price.IsSelected)
                                                        {
                                                            <MudTooltip Text="Remover seleção de vencedor">
                                                                <MudButton Variant="Variant.Filled" Color="Color.Error"
                                                                    Size="Size.Small"
                                                                    StartIcon="@Icons.Material.Filled.RemoveShoppingCart"
                                                                    OnClick="@(() => SelectWinner(price.Id))"
                                                                    Class="d-none d-sm-inline-flex">

                                                                </MudButton>
                                                            </MudTooltip>
                                                            <MudTooltip Text="Remover">
                                                                        <MudIconButton Icon="@Icons.Material.Filled.RemoveShoppingCart"
                                                                            Size="Size.Small" Color="Color.Error" Variant="Variant.Filled"
                                                                            OnClick="@(() => SelectWinner(price.Id))"
                                                                            Class="d-inline-flex d-sm-none" aria-label="Remover seleção" />
                                                            </MudTooltip>
                                                        }
                                                        else
                                                        {
                                                            <MudTooltip Text="Selecionar como vencedor">
                                                                <MudButton Variant="Variant.Filled" Color="Color.Success"
                                                                    Size="Size.Small" StartIcon="@Icons.Material.Filled.ShoppingCart"
                                                                    OnClick="@(() => SelectWinner(price.Id))"
                                                                    Class="d-none d-sm-inline-flex">

                                                                </MudButton>
                                                            </MudTooltip>
                                                            <MudTooltip Text="Selecionar">
                                                                <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart"
                                                                    Size="Size.Small" Color="Color.Success" Variant="Variant.Filled"
                                                                    OnClick="@(() => SelectWinner(price.Id))"
                                                                    Class="d-inline-flex d-sm-none" aria-label="Selecionar como vencedor" />
                                                            </MudTooltip>
                                                        }

                                                        <MudTooltip Text="Editar Preço">
                                                            <MudButton Variant="Variant.Filled" Color="Color.Warning"
                                                                Size="Size.Small" StartIcon="@Icons.Material.Filled.Edit"
                                                                OnClick="@(() => OpenEditPriceDialog(quoteItemId, price))"
                                                                Class="d-none d-sm-inline-flex">

                                                            </MudButton>
                                                        </MudTooltip>
                                                        <MudTooltip Text="Editar">
                                                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                                                Color="Color.Warning"
                                                                OnClick="@(() => OpenEditPriceDialog(quoteItemId, price))"
                                                                Class="d-inline-flex d-sm-none" />
                                                        </MudTooltip>

                                                        <MudTooltip Text="Excluir Preço">
                                                            <MudButton Variant="Variant.Filled" Color="Color.Error"
                                                                Size="Size.Small" StartIcon="@Icons.Material.Filled.Delete"
                                                                OnClick="@(() => DeletePrice(price.Id))"
                                                                Class="d-none d-sm-inline-flex">

                                                            </MudButton>
                                                        </MudTooltip>
                                                        <MudTooltip Text="Excluir">
                                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small"
                                                                Color="Color.Error" OnClick="@(() => DeletePrice(price.Id))"
                                                                Class="d-inline-flex d-sm-none" />
                                                        </MudTooltip>
                                                    </MudTd>
                                                </RowTemplate>
                                            </MudTable>
                                        </MudPaper>
                                    }
                                    else
                                    {
                                        <MudAlert Severity="Severity.Info" Class="ma-3" Dense="true">
                                            Nenhum preço cadastrado para este item.
                                        </MudAlert>
                                    }
                                </td>
                            </MudTr>
                        }
                    </ChildRowContent>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    [Parameter] public Guid QuoteId { get; set; }

    private GetQuoteByIdResponse? _quote;
    private bool _loading = true;
    private HashSet<Guid> _expandedItems = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadQuote();
    }

    private void ToggleExpand(Guid itemId)
    {
        if (_expandedItems.Contains(itemId))
        {
            _expandedItems.Remove(itemId);
        }
        else
        {
            _expandedItems.Add(itemId);
        }
    }

    

    private void NavigateToSummary()
    {
        Navigation.NavigateTo($"cotacoes/{QuoteId}/resumo");
    }

    private void GoBack()
    {
        Navigation.NavigateTo("cotacoes");
    }

    private async Task LoadQuote()
    {
        try
        {
            _loading = true;
            _quote = await QuotesService.GetQuoteByIdAsync(QuoteId);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar cotação: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenEditQuoteDialog()
    {
        if (_quote == null) return;

        var parameters = new DialogParameters<EditQuoteDialog>
{
{ x => x.QuoteId, QuoteId },
{ x => x.Quote, _quote }
};

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<EditQuoteDialog>("Editar Cotação", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadQuote();
        }
    }

    private async Task OpenUpdateStatusDialog()
    {
        if (_quote == null) return;

        var parameters = new DialogParameters<UpdateStatusDialog>
{
{ x => x.QuoteId, QuoteId },
{ x => x.CurrentStatus, _quote.Status }
};

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<UpdateStatusDialog>("Alterar Status", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadQuote();
        }
    }

    private async Task OpenAddItemDialog()
    {
        var parameters = new DialogParameters<QuoteItemFormDialog>
{
{ x => x.QuoteId, QuoteId }
};

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<QuoteItemFormDialog>("Adicionar Item", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadQuote();
        }
    }

    private async Task OpenEditItemDialog(Guid itemId)
    {
        var parameters = new DialogParameters<QuoteItemFormDialog>
{
{ x => x.QuoteId, QuoteId },
{ x => x.QuoteItemId, itemId }
};

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<QuoteItemFormDialog>("Editar Item", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadQuote();
        }
    }

    private async Task OpenAddPriceDialog(Guid quoteItemId)
    {
        var parameters = new DialogParameters<SupplierPriceFormDialog>
{
{ x => x.QuoteId, QuoteId },
{ x => x.QuoteItemId, quoteItemId }
};

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SupplierPriceFormDialog>("Adicionar Preço de Fornecedor", parameters,
        options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadQuote();
        }
    }

    private async Task OpenEditPriceDialog(Guid quoteItemId, SupplierPriceResponse price)
    {
        var parameters = new DialogParameters<SupplierPriceFormDialog>
{
{ x => x.QuoteId, QuoteId },
{ x => x.QuoteItemId, quoteItemId },
{ x => x.SupplierPriceId, price.Id }
};

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SupplierPriceFormDialog>("Editar Preço de Fornecedor", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await LoadQuote();
        }
    }

    private async Task SelectWinner(Guid supplierPriceId)
    {
        try
        {
            var command = new SelectSupplierPriceWinnerCommand { SupplierPriceId = supplierPriceId };
            await QuotesService.SelectWinnerAsync(command);
            Snackbar.Add("Fornecedor vencedor selecionado!", Severity.Success);
            await LoadQuote();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao selecionar vencedor: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeletePrice(Guid supplierPriceId)
    {
        bool? confirmed = await DialogService.ShowMessageBox(
        "Confirmar exclusão",
        "Tem certeza que deseja excluir este preço?",
        yesText: "Excluir",
        cancelText: "Cancelar");

        if (confirmed == true)
        {
            try
            {
                await QuotesService.DeleteSupplierPriceAsync(supplierPriceId);
                Snackbar.Add("Preço excluído com sucesso!", Severity.Success);
                await LoadQuote();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Erro ao excluir preço: {ex.Message}", Severity.Error);
            }
        }
    }

    private Color GetStatusColor(string status)
    {
        return status?.ToLower() switch
        {
            "pendente" => Color.Warning,
            "aprovada" => Color.Success,
            "rejeitada" => Color.Error,
            "cancelada" => Color.Default,
            _ => Color.Info
        };
    }
}