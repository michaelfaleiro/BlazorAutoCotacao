@page "/cotacoes"
@using BlazorAutoCotacao.Dtos.Response
@using BlazorAutoCotacao.Services
@using MudBlazor
@inject QuotesService QuotesService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationManager Navigation

<MudText Typo="Typo.h4" Class="mb-4">Cotações</MudText>

<MudPaper Class="pa-4" Elevation="2">
    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-3">
        <MudTextField @bind-Value="_searchString" 
                      Placeholder="Buscar cotações..." 
                      Adornment="Adornment.Start" 
                      AdornmentIcon="@Icons.Material.Filled.Search" 
                      IconSize="Size.Medium"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Style="max-width: 400px;"
                      DebounceInterval="500"
                      OnDebounceIntervalElapsed="OnSearch"
                      Immediate="false"
                      Clearable="true"/>
        <MudStack Row="true" Spacing="1">
            <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Small" StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="ResetFilters">Limpar</MudButton>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Success" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog"
                       Size="Size.Small">
                Nova Cotação
            </MudButton>
        </MudStack>
    </MudStack>

    <MudDataGrid T="GetAllQuotesResponse" 
                 ServerData="LoadServerData"
                 Dense="true"
                 Hover="true"
                 Bordered="false"
                 Striped="false"
                 @ref="_dataGrid"
                 SortMode="SortMode.Single"
                 Filterable="false"
                 Hideable="false"
                 RowsPerPage="25">
        <Columns>
            
            <PropertyColumn Property="x => x.VehicleModel" Title="Modelo" Sortable="true"/>
            <PropertyColumn Property="x => x.VehicleLicencePlate" Title="Placa" Sortable="true">
                <CellTemplate>
                    @context.Item.VehicleLicencePlate.ToUpper()
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Status" Title="Status" Sortable="true">
                <CellTemplate>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Item.Status)">
                        @context.Item.Status
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>
            <TemplateColumn Title="Criado em" Sortable="true" SortBy="@(x => x.CreatedAt)" Hideable="true" Hidden="@(_isMobile)">
                <CellTemplate>
                    @TextHelpers.ToLocalString(context.Item.CreatedAt, "dd/MM/yy HH:mm")
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Ações" Sortable="false" Filterable="false" Hideable="false" 
                           HeaderStyle="text-align: right; width: 120px;" 
                           CellStyle="text-align: right;">
                <CellTemplate>
                    <MudTooltip Text="Visualizar Detalhes">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                       Size="Size.Small" 
                                       Color="Color.Info"
                                       OnClick="@(() => NavigateToDetails(context.Item.Id))"/>
                    </MudTooltip>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager T="GetAllQuotesResponse" 
                             RowsPerPageString="Linhas por página:"/>
        </PagerContent>
    </MudDataGrid>
    
    @if (_totalItems > 0)
    {
        <MudText Typo="Typo.body2" Class="mt-2 ml-2">
            @GetPaginationInfo()
        </MudText>
    }
</MudPaper>

@code {
    private MudDataGrid<GetAllQuotesResponse>? _dataGrid;
    private string _searchString = string.Empty;
    private bool _isMobile = false;
    private string? _statusFilter = null;

    protected override void OnInitialized()
    {
        // Simples detecção mobile - pode ser melhorado com JS Interop se necessário
        _isMobile = false;
        // Parse status query parameter if present
        try
        {
            var uri = new Uri(Navigation.Uri);
            var query = uri.Query;
            if (!string.IsNullOrWhiteSpace(query))
            {
                var pairs = query.TrimStart('?').Split('&', StringSplitOptions.RemoveEmptyEntries);
                foreach (var p in pairs)
                {
                    var kv = p.Split('=', 2);
                    if (kv.Length == 2)
                    {
                        var key = Uri.UnescapeDataString(kv[0]);
                        var val = Uri.UnescapeDataString(kv[1]);
                        if (string.Equals(key, "status", StringComparison.OrdinalIgnoreCase))
                        {
                            _statusFilter = val;
                        }
                    }
                }
            }
        }
        catch
        {
            // ignore parsing errors
        }
    }
    private int _totalItems = 0;
    private int _currentPage = 0;
    private int _pageSize = 25;

    private string GetPaginationInfo()
    {
        if (_totalItems == 0) return "0 registros";
        
        var firstItem = (_currentPage * _pageSize) + 1;
        var lastItem = Math.Min((_currentPage + 1) * _pageSize, _totalItems);
        return $"{firstItem}-{lastItem} de {_totalItems} registros";
    }

    private async Task OnSearch()
    {
        if (_dataGrid != null)
        {
            await _dataGrid.ReloadServerData();
        }
    }

    private async Task ResetFilters()
    {
        _searchString = string.Empty;
        _statusFilter = null;
        // remove query param from URL
        Navigation.NavigateTo("/cotacoes", replace: true);
        if (_dataGrid != null)
        {
            await _dataGrid.ReloadServerData();
        }
    }

    private async Task<GridData<GetAllQuotesResponse>> LoadServerData(GridState<GetAllQuotesResponse> state)
    {
        try
        {
            string orderBy = "createdAt";
            if (state.SortDefinitions.Any())
            {
                var sortDef = state.SortDefinitions.First();
                var sortByRaw = sortDef.SortBy ?? string.Empty;
                if (sortByRaw.Contains("VehicleModel", StringComparison.OrdinalIgnoreCase))
                    orderBy = sortDef.Descending ? "vehicleModel_desc" : "vehicleModel";
                else if (sortByRaw.Contains("VehicleLicencePlate", StringComparison.OrdinalIgnoreCase))
                    orderBy = sortDef.Descending ? "vehicleLicencePlate_desc" : "vehicleLicencePlate";
                else if (sortByRaw.Contains("Status", StringComparison.OrdinalIgnoreCase))
                    orderBy = sortDef.Descending ? "status_desc" : "status";
                else if (sortByRaw.Contains("CreatedAt", StringComparison.OrdinalIgnoreCase))
                    orderBy = sortDef.Descending ? "createdAt_desc" : "createdAt";
                else
                    orderBy = "createdAt";
            }

            var response = await QuotesService.GetAllQuotesAsync(
                search: string.IsNullOrWhiteSpace(_searchString) ? null : _searchString,
                vehicleModel: null,
                vehicleLicencePlate: null,
                vehicleVin: null,
                status: string.IsNullOrWhiteSpace(_statusFilter) ? null : _statusFilter,
                orderBy: orderBy,
                page: state.Page + 1,
                pageSize: state.PageSize
            );

            _totalItems = response.TotalCount;
            _currentPage = state.Page;
            _pageSize = state.PageSize;

            return new GridData<GetAllQuotesResponse>
            {
                Items = response.Data,
                TotalItems = response.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao carregar cotações: {ex.Message}", Severity.Error);
            _totalItems = 0;
            return new GridData<GetAllQuotesResponse>
            {
                Items = new List<GetAllQuotesResponse>(),
                TotalItems = 0
            };
        }
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall, FullWidth = true };
        var dialog = await DialogService.ShowAsync<CreateQuoteDialog>("Nova Cotação", options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is Guid quoteId)
        {
            Navigation.NavigateTo($"cotacoes/{quoteId}");
        }
    }

    private void NavigateToDetails(Guid id)
    {
        Navigation.NavigateTo($"cotacoes/{id}");
    }

    private Color GetStatusColor(string status)
    {
        return status?.ToLower() switch
        {
            "novo" => Color.Warning,
            "parcial" => Color.Info,
            "finalizado" => Color.Success,
            "cancelado" => Color.Default,
            _ => Color.Info
        };
    }
}
